name: CI/CD

on:
  push:
    branches: [develop, ref, main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  clang-format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || github.ref }}

    - name: Install clang-format
      run: sudo apt-get update && sudo apt-get install -y clang-format

    - name: clang-format
      run: |
        FILES=$(find . -type f -regex '.*\.\(cpp\|hpp\|h\)$' \
                -not -path "./build/*" \
                -not -path "./third_party/*")
        if [ -z "$FILES" ]; then
          echo "No C++ files found. Skipping."
          exit 0
        fi
        echo "Checking formatting for files:"
        echo "$FILES"
        clang-format --dry-run --Werror --style=file $FILES || \
          (echo "❌ Formatting errors found! Run 'clang-format -i YOUR_FILE' to fix."; exit 1)

  build:
    runs-on: archlinux
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || github.ref }}

    - name: Install dependencies
      run: |
        sudo pacman -S --noconfirm --needed cmake sfml gcc

    - name: Configure CMake
      timeout-minutes: 5
      run: |
        mkdir -p App/build
        cd App/build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        echo "CMake configuration completed"

    - name: Build project
      timeout-minutes: 10
      working-directory: ./App/build
      run: cmake --build . --config Release -- -j 2

    - name: Verify executable
      working-directory: ./App
      run: |
        if [ -f "./ImageEditor" ]; then
          echo "✅ Executable built successfully with SFML 3.0.1"
          ls -lh ./ImageEditor
        else
          echo "❌ Executable not found!"
          exit 1
        fi