name: clang-format

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  clang-format:
    name: Verify clang-format compliance
    runs-on: ubuntu-latest

    if: github.base_ref == 'main' && github.head_ref == 'develop'

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Install clang-format
      run: sudo apt-get update && sudo apt-get install -y clang-format

    - name: Check formatting
      run: |
        # Ищем все C/C++ файлы (исключаем папки build/ и third_party/)
        FILES=$(find . -type f -regex '.*\.\(cpp\|hpp\|h\|c\|cc\|cxx\)$' \
                -not -path "./build/*" \
                -not -path "./third_party/*")

        if [ -z "$FILES" ]; then
          echo "No source files found. Skipping."
          exit 0
        fi

        clang-format --dry-run --Werror --style=file $FILES || \
          (echo "❌ Code formatting issues found! Run 'clang-format -i' to fix."; exit 1)
